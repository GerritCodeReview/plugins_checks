{
  "comments": [
    {
      "key": {
        "uuid": "469de901_dda8e807",
        "filename": "java/com/google/gerrit/plugins/checks/CheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 29,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2020-03-13T12:15:45Z",
      "side": 1,
      "message": "I\u0027d move this into the CheckerRefMigration class and make it (package private) because it\u0027s only needed for that.",
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1cccd1dd_6d26df9c",
        "filename": "java/com/google/gerrit/plugins/checks/CheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 29,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2020-03-13T13:18:08Z",
      "side": 1,
      "message": "I do use it in tests, but now also added it to CheckerOperations.",
      "parentUuid": "469de901_dda8e807",
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "cee755de_ec28a19f",
        "filename": "java/com/google/gerrit/plugins/checks/CheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 29,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2020-03-16T17:59:24Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "1cccd1dd_6d26df9c",
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c3d924cd_edc72de1",
        "filename": "java/com/google/gerrit/plugins/checks/api/MigrationCheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 41,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2020-03-13T12:15:45Z",
      "side": 1,
      "message": "nit: CheckerRefMigration",
      "range": {
        "startLine": 41,
        "startChar": 13,
        "endLine": 41,
        "endChar": 32
      },
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7d86286f_ae38803d",
        "filename": "java/com/google/gerrit/plugins/checks/api/MigrationCheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 41,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2020-03-13T13:18:08Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "c3d924cd_edc72de1",
      "range": {
        "startLine": 41,
        "startChar": 13,
        "endLine": 41,
        "endChar": 32
      },
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "902c9dac_5b398e73",
        "filename": "java/com/google/gerrit/plugins/checks/api/MigrationCheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 62,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2020-03-13T12:15:45Z",
      "side": 1,
      "message": "nit: this should be a private static final TMP_REF member of the class.\nnit: refs/tmp/checker-migration",
      "range": {
        "startLine": 62,
        "startChar": 22,
        "endLine": 62,
        "endChar": 69
      },
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b804f034_488be0fb",
        "filename": "java/com/google/gerrit/plugins/checks/api/MigrationCheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 62,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2020-03-13T13:18:08Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "902c9dac_5b398e73",
      "range": {
        "startLine": 62,
        "startChar": 22,
        "endLine": 62,
        "endChar": 69
      },
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "408b7748_75766333",
        "filename": "java/com/google/gerrit/plugins/checks/api/MigrationCheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 66,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2020-03-13T12:15:45Z",
      "side": 1,
      "message": "Right now, we do:\n\n1) Rename refs/meta/checkers/ to refs/tmp/...\n2) Rename refs/tmp/... to refs/meta/checkers\n\nDid you check if we can do:\n1) Create refs/meta/checkers and have it point to the tip of refs/meta/checkers/\n2) Delete refs/meta/checkers/\n\nThat\u0027d spare the tmp.",
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "15bc47a6_5cd64dec",
        "filename": "java/com/google/gerrit/plugins/checks/api/MigrationCheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 66,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2020-03-13T13:18:08Z",
      "side": 1,
      "message": "I could - but I can see why it wouldn\u0027t work for the same reason as many other things (LOCK_FAILURE when deleting refs/meta/checkers/).\nThis check requires checking both upstream and internally, and sounds time-consuming. \nCan we skip this, since it also doesn\u0027t have much added value?",
      "parentUuid": "408b7748_75766333",
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "82516483_977432d2",
        "filename": "java/com/google/gerrit/plugins/checks/api/MigrationCheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 66,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2020-03-13T14:29:42Z",
      "side": 1,
      "message": "I see no reason, why it would not work (it\u0027s the exact same operations, create and delete refs) and it protects us against a temporary intermediary state, so I recommend trying it. I left some code in the other comment that should work.",
      "parentUuid": "15bc47a6_5cd64dec",
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ed859e13_889586c3",
        "filename": "java/com/google/gerrit/plugins/checks/api/MigrationCheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 66,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2020-03-16T17:59:24Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "82516483_977432d2",
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8805c212_d0cc508d",
        "filename": "java/com/google/gerrit/plugins/checks/api/MigrationCheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 95,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2020-03-13T12:15:45Z",
      "side": 1,
      "message": "Using a BatchUpdate is unnecessary because you are just deleting a single ref. The following example is from DeleteRef:\n\n    try (Repository repository \u003d repoManager.openRepository(allProjectsName)) {\n      RefUpdate.Result result;\n      RefUpdate u \u003d repository.updateRef(refName);\n      u.setExpectedOldObjectId(repository.exactRef(ref).getObjectId());\n      u.setNewObjectId(ObjectId.zeroId());\n      u.setForceUpdate(true);\n      RefUpdateUtil.checkResult(u.delete());\n    }\n\nThis allows you to delete the Op further down.",
      "range": {
        "startLine": 95,
        "startChar": 9,
        "endLine": 95,
        "endChar": 20
      },
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "721b8405_e1613ef1",
        "filename": "java/com/google/gerrit/plugins/checks/api/MigrationCheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 95,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2020-03-13T13:18:08Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "8805c212_d0cc508d",
      "range": {
        "startLine": 95,
        "startChar": 9,
        "endLine": 95,
        "endChar": 20
      },
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "d076943a_f7fc0e6e",
        "filename": "java/com/google/gerrit/plugins/checks/api/MigrationCheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 97,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2020-03-13T12:15:45Z",
      "side": 1,
      "message": "allProjectsName is a subclass of Project.NameKey, so you can replace this by \"allProjectsName\".",
      "range": {
        "startLine": 97,
        "startChar": 11,
        "endLine": 97,
        "endChar": 50
      },
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6ff8d490_1db81533",
        "filename": "java/com/google/gerrit/plugins/checks/api/MigrationCheckerRef.java",
        "patchSetId": 4
      },
      "lineNbr": 97,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2020-03-13T13:18:08Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "d076943a_f7fc0e6e",
      "range": {
        "startLine": 97,
        "startChar": 11,
        "endLine": 97,
        "endChar": 50
      },
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "294588bb_904e0280",
        "filename": "javatests/com/google/gerrit/plugins/checks/acceptance/testsuite/MigrationCheckerRefIT.java",
        "patchSetId": 4
      },
      "lineNbr": 51,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2020-03-13T12:15:45Z",
      "side": 1,
      "message": "Please assert that refs in the repo both before and after your migration. So check that before we have a refs/meta/checkers/ and after we have a refs/meta/checkers",
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "01c924c3_3c29c675",
        "filename": "javatests/com/google/gerrit/plugins/checks/acceptance/testsuite/MigrationCheckerRefIT.java",
        "patchSetId": 4
      },
      "lineNbr": 51,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2020-03-13T13:18:08Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "294588bb_904e0280",
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4a79bf59_e36f4505",
        "filename": "javatests/com/google/gerrit/plugins/checks/acceptance/testsuite/MigrationCheckerRefIT.java",
        "patchSetId": 4
      },
      "lineNbr": 51,
      "author": {
        "id": 1026112
      },
      "writtenOn": "2020-03-17T08:00:00Z",
      "side": 1,
      "message": "This code still looks the same?\n\nThis could be something like:\n\nRef legacy \u003d repo.exactRef(\"refs/meta/checkers/\");\nassertThat(legacy).isNotNull();\nassertThat(repo.exactRef(\"refs/meta/checkers\")).isNull();\n\n// migrate\n\nassertThat(repo.exactRef(\"refs/meta/checkers/\")).isNull();\nRef migrated \u003d repo.exactRef(\"refs/meta/checkers/\");\nassertThat(migrated).isNotNull();\nassertThat(migrated.objectId()).isEqualTo(legacy.objectId());",
      "parentUuid": "01c924c3_3c29c675",
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "819aef99_f9f3bd5e",
        "filename": "javatests/com/google/gerrit/plugins/checks/acceptance/testsuite/MigrationCheckerRefIT.java",
        "patchSetId": 4
      },
      "lineNbr": 51,
      "author": {
        "id": 1085183
      },
      "writtenOn": "2020-03-17T11:55:24Z",
      "side": 1,
      "message": "But this is what checkersOf is doing\nAs you requested in another comment, checkersOf(allProjects) is using the correct ref, and checkersOf(allProjects,\"refs/meta/checkers/\" using the old ref.",
      "parentUuid": "4a79bf59_e36f4505",
      "revId": "4fbcd9e838f5c4d08538e2234f200a45f08ebb18",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    }
  ]
}